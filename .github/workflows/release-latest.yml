name: Release Latest

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: Hide theme editor button (keep keyboard shortcut)
  prepare-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Hide theme editor button
        run: |
          # Comment out the theme editor button in ui.rs (lines 682-684)
          # Keep the keyboard shortcut (Ctrl+T) intact at lines 54-56
          sed -i '682,684s/^/\/\/ /' src/app/ui.rs

          # Verify the change
          echo "Theme button hidden. Verifying changes:"
          echo "Lines 682-684 (should be commented):"
          sed -n '682,684p' src/app/ui.rs
          echo ""
          echo "Lines 54-56 (should be active):"
          sed -n '54,56p' src/app/ui.rs

      - name: Upload modified source
        uses: actions/upload-artifact@v4
        with:
          name: modified-source
          path: .
          retention-days: 1

  # Step 2: Build Windows
  build-windows:
    needs: prepare-source
    runs-on: windows-latest
    steps:
      - name: Download modified source
        uses: actions/download-artifact@v4
        with:
          name: modified-source
          path: .

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc --features icon

      - name: Rename binary
        shell: bash
        run: cp "target/x86_64-pc-windows-msvc/release/spruceos-installer.exe" "spruceos-installer-windows.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spruceos-installer-windows.exe
          path: spruceos-installer-windows.exe
          retention-days: 1

  # Step 3: Build Linux (all architectures)
  build-linux:
    needs: prepare-source
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            target: x86_64-unknown-linux-gnu
            artifact: spruceos-installer-linux-x64
            build_cmd: cargo zigbuild --release --target x86_64-unknown-linux-gnu.2.17 --features icon

          - arch: arm64
            target: aarch64-unknown-linux-gnu
            artifact: spruceos-installer-linux-arm64
            build_cmd: cargo zigbuild --release --target aarch64-unknown-linux-gnu.2.17 --features icon

          - arch: i686
            target: i686-unknown-linux-gnu
            artifact: spruceos-installer-linux-i686
            build_cmd: cargo zigbuild --release --target i686-unknown-linux-gnu.2.17 --features icon

          - arch: armv7
            target: armv7-unknown-linux-gnueabihf
            artifact: spruceos-installer-linux-armv7
            build_cmd: cargo zigbuild --release --target armv7-unknown-linux-gnueabihf.2.17 --features icon

    steps:
      - name: Download modified source
        uses: actions/download-artifact@v4
        with:
          name: modified-source
          path: .

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install cargo-zigbuild
        run: cargo install cargo-zigbuild

      - name: Cache cargo + target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-
            ${{ runner.os }}-cargo-

      - name: Build
        run: ${{ matrix.build_cmd }}

      - name: Rename binary
        shell: bash
        run: |
          TARGET_DIR="${{ matrix.target }}"
          TARGET_DIR="${TARGET_DIR%%.*}"
          cp "target/${TARGET_DIR}/release/spruceos-installer" "${{ matrix.artifact }}"
          chmod +x "${{ matrix.artifact }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
          retention-days: 1

  # Step 4: Build macOS Universal
  build-macos:
    needs: prepare-source
    runs-on: macos-latest
    steps:
      - name: Download modified source
        uses: actions/download-artifact@v4
        with:
          name: modified-source
          path: .

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Build ARM64 (Apple Silicon)
        run: cargo build --release --target aarch64-apple-darwin --features icon

      - name: Build x64 (Intel)
        run: cargo build --release --target x86_64-apple-darwin --features icon

      - name: Create macOS Icon
        run: |
          mkdir -p AppIcon.iconset
          sips -z 16 16     "assets/Icons/icon.png" --out "AppIcon.iconset/icon_16x16.png"
          sips -z 32 32     "assets/Icons/icon.png" --out "AppIcon.iconset/icon_16x16@2x.png"
          sips -z 32 32     "assets/Icons/icon.png" --out "AppIcon.iconset/icon_32x32.png"
          sips -z 64 64     "assets/Icons/icon.png" --out "AppIcon.iconset/icon_32x32@2x.png"
          sips -z 128 128   "assets/Icons/icon.png" --out "AppIcon.iconset/icon_128x128.png"
          sips -z 256 256   "assets/Icons/icon.png" --out "AppIcon.iconset/icon_128x128@2x.png"
          sips -z 256 256   "assets/Icons/icon.png" --out "AppIcon.iconset/icon_256x256.png"
          sips -z 512 512   "assets/Icons/icon.png" --out "AppIcon.iconset/icon_256x256@2x.png"
          sips -z 512 512   "assets/Icons/icon.png" --out "AppIcon.iconset/icon_512x512.png"
          sips -z 1024 1024 "assets/Icons/icon.png" --out "AppIcon.iconset/icon_512x512@2x.png"
          iconutil -c icns AppIcon.iconset -o AppIcon.icns

      - name: Create launcher script
        run: |
          cat > launch-installer.command << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          APP_PATH="$SCRIPT_DIR/SpruceOSInstaller.app"
          echo "SpruceOS Installer Launcher"
          echo "============================"
          echo "Removing quarantine attribute..."
          xattr -d com.apple.quarantine "$APP_PATH" 2>/dev/null
          echo "Launching SpruceOS Installer..."
          open "$APP_PATH"
          EOF
          chmod +x launch-installer.command

      - name: Create Universal App Bundle
        run: |
          lipo -create -output spruceos-installer-universal \
            target/aarch64-apple-darwin/release/spruceos-installer \
            target/x86_64-apple-darwin/release/spruceos-installer

          echo "Universal binary architectures:"
          lipo -info spruceos-installer-universal

          mkdir -p "SpruceOSInstaller.app/Contents/MacOS"
          mkdir -p "SpruceOSInstaller.app/Contents/Resources"

          cp spruceos-installer-universal "SpruceOSInstaller.app/Contents/MacOS/spruceos-installer"
          chmod +x "SpruceOSInstaller.app/Contents/MacOS/spruceos-installer"

          cp "assets/Mac/Info.plist" "SpruceOSInstaller.app/Contents/"
          cp "AppIcon.icns" "SpruceOSInstaller.app/Contents/Resources/"
          cp "assets/Mac/7zz" "SpruceOSInstaller.app/Contents/Resources/7zz"
          chmod +x "SpruceOSInstaller.app/Contents/Resources/7zz"

          xattr -cr "SpruceOSInstaller.app"

          zip -r "SpruceOS-Installer-macOS-Universal.zip" "SpruceOSInstaller.app" "launch-installer.command"

      - name: Upload Universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: SpruceOS-Installer-macOS-Universal
          path: SpruceOS-Installer-macOS-Universal.zip
          retention-days: 1

  # Step 5: Create Latest Release
  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize artifacts
        run: |
          mkdir -p release-files
          find artifacts -type f -name "spruceos-installer-*" -exec cp {} release-files/ \;
          find artifacts -type f -name "*.zip" -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Checkout (for gh CLI)
        uses: actions/checkout@v4

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Delete existing 'latest' release and tag
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete latest --yes --repo ${{ github.repository }} || true
          git push --delete origin latest || true

      - name: Create Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Release (${{ steps.date.outputs.date }})
          body: |
            ## SpruceOS Installer - Latest Release

            **Released:** ${{ steps.date.outputs.date }}

            This is the latest stable release of the SpruceOS Installer.

            ---

            ## ðŸ“¦ Downloads

            ### Windows
            - **Windows (x64):** `spruceos-installer-windows.exe`

            ### Linux
            - **Linux x64:** `spruceos-installer-linux-x64`
            - **Linux ARM64:** `spruceos-installer-linux-arm64`
            - **Linux i686 (32-bit):** `spruceos-installer-linux-i686`
            - **Linux ARMv7:** `spruceos-installer-linux-armv7`

            ### macOS
            - **macOS Universal (Intel + Apple Silicon):** `SpruceOS-Installer-macOS-Universal.zip`

            ---

            ## ðŸªŸ Windows Instructions

            1. Download `spruceos-installer-windows.exe`
            2. Run the executable
            3. If Windows SmartScreen appears, click "More info" â†’ "Run anyway"
            4. The installer will request administrator privileges when needed

            **Requirements:** Windows 7 or later (x64)

            ---

            ## ðŸ§ Linux Instructions

            1. Download the appropriate binary for your architecture
            2. Make it executable: `chmod +x spruceos-installer-linux-*`
            3. Run: `./spruceos-installer-linux-*`
            4. The installer will request privileges via `pkexec` when needed

            **Requirements:** Desktop environment with `pkexec` support

            ---

            ## ðŸŽ macOS Instructions

            ### First Time Setup:

            **Grant Terminal Full Disk Access:**
            1. Open **System Settings** â†’ **Privacy & Security** â†’ **Full Disk Access**
            2. Click the **lock icon** and enter your password
            3. Click **+** and add **Applications/Utilities/Terminal.app**
            4. Check the box next to Terminal
            5. **Quit and reopen Terminal**

            ### Running the Installer:
            1. Extract the zip file
            2. Double-click `launch-installer.command`

            **Alternative:** Right-click "SpruceOSInstaller.app" â†’ "Open" â†’ "Open"

            **Requirements:** macOS 10.13+ (High Sierra or later)
            **Architecture:** Universal binary for Apple Silicon (M1/M2/M3/M4) and Intel Macs

            ---

            ## ðŸ“ Notes

            - All binaries are **not code-signed** (will show security warnings)
            - See [README](https://github.com/${{ github.repository }}) for full documentation
          draft: false
          prerelease: false
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Latest Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release tag: \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "Date: ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platforms Built:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows (x64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux (x64, ARM64, i686, ARMv7)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS (Universal: Intel + Apple Silicon)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Theme Editor:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ Button: Hidden from UI" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ¨ï¸ Keyboard shortcut (Ctrl+T): Still functional" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/latest)" >> $GITHUB_STEP_SUMMARY
